Предположим, вы планируете архитектуру приложения для обмена музыкой. Вам необходимо обеспечить надежную передачу музыкальных файлов из мобильного приложения в веб-API.

Определив, что взаимодействие должно осуществляться в форме сообщений, вам следует выбрать для использования очереди службы хранилища Azure или Служебную шину. Оба этих решения можно применять для хранения очередей сообщений, ожидающих обработки.

## <a name="delivery-guarantees"></a>Гарантии доставки

Системы очередей обычно гарантируют доставку каждого сообщения в очереди компоненту-получателю. Однако для этого могут применяться разные подходы.

- **Доставка по крайней мере один раз**. При таком подходе каждое сообщение гарантированно доставляется по крайней мере одному из компонентов, получающему сообщения из очереди. Однако имейте в виду, что в некоторых ситуациях одно и то же сообщение может доставляться несколько раз. Например, если два экземпляра веб-приложения получают сообщения из очереди, обычно каждое сообщение передается только одному из них. Однако если этот экземпляр обрабатывает сообщение слишком долго и время ожидания истекает, сообщение может быть отправлено также и второму. Это следует учитывать при написании кода веб-приложения.
- **Доставка не более одного раза**. При таком подходе доставка каждого сообщения не гарантируется. Существует очень небольшая вероятность того, что оно не поступит. Однако одно и то же сообщение не может быть доставлено дважды, как в случае с доставкой по крайней мере один раз.
- **В порядке поступления (FIFO)**. В большинстве систем обмена сообщениями сообщения обычно покидают очередь в том же порядке, в котором они были добавлены. Однако необходимо убедиться в том, что такая очередность гарантирована. Если ваше распределенное приложение требует, чтобы сообщения обрабатывались именно в таком порядке, следует выбрать систему очередей, дающую гарантию обработки FIFO.

## <a name="transactions"></a>Транзакции

Если несколько сообщений тесно связаны между собой, сбой доставки одного из них может вызвать проблемы.

Возьмем для примера приложение электронной коммерции. Когда пользователь нажимает кнопку "Купить", вместе с сообщением со сведениями о заказе отправляется сообщение с данными кредитной карты. Если сообщение с данными кредитной карты не было доставлено, заказ может быть отправлен без оплаты.

Чтобы избежать подобных проблем, можно объединить сообщения в транзакцию. Транзакция завершается успешно или неудачно как одно целое. Если сообщение с данными кредитной карты доставить не удается, то же самое происходит и с сообщением со сведениями о заказе.

## <a name="when-to-use-storage-queues"></a>Когда следует использовать очереди службы хранилища

Очереди применяются для сообщений, но не для событий.

Учетные записи хранения Azure включают в себя очереди, которые могут использоваться распределенными приложениями в качестве простого временного хранилища сообщений. Компонент-источник может добавить сообщение в очередь. Компоненты-получатели извлекают сообщение для обработки из начала очереди. Такие очереди повышают надежность обмена сообщениями, так как во время высокой загрузки сообщения могут ожидать, пока компонент-получатель будет готов обработать их.

Очереди также предоставляются в рамках системы обмена сообщениями Служебной шины. Если вы решили использовать очередь в Azure для определенного взаимодействия, следует выбрать, что подходит лучше: очередь службы хранилища или очередь Служебной шины.

Чтобы сделать правильный выбор, ответьте на приведенные ниже вопросы.

- Требуется ли гарантия доставки не более одного раза?
- Требуется ли гарантия доставки в порядке FIFO?
- Нужно ли объединять сообщения в транзакции?
- Нужно ли хранить сообщения размером более 64 КБ?

Если ответ на какие-либо из этих вопросов утвердительный, следует выбрать очередь Служебной шины.

Кроме того, ответьте на приведенные ниже вопросы.

- Требуются ли журналы всех сообщений, проходящих через очередь, на стороне сервера?
- Может ли размер очереди превышать 80 ГБ?

Если ответ на какие-либо из этих вопросов утвердительный, следует выбрать очередь службы хранилища.

## <a name="summary"></a>Сводка

Очередь — это простое временное хранилище сообщений, передаваемых между компонентами распределенного приложения. Она позволяет упорядочивать сообщения и справляться с неожиданными скачками нагрузки.

Используйте очереди службы хранилища Azure, если вам нужна простая и легко программируемая система очередей. Для более сложных случаев используйте очереди Служебной шины Azure.