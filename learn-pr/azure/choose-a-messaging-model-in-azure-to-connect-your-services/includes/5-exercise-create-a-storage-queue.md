В этом упражнении вы создадите учетную запись хранения в своей подписке Azure. Затем, используя Azure Cloud Shell, вы создадите очередь, добавите в нее сообщение, а затем прочтете это сообщение и удалите его из очереди.

Точно такие же действия выполняют компоненты в распределенном приложении. Например, мобильное приложение может добавлять сообщение в очередь, в которой оно будет ожидать, пока веб-служба не извлечет и не обработает это сообщение.

## <a name="create-a-storage-account"></a>Создание учетной записи хранения

Поскольку очереди хранилища относятся к учетным записям хранения Azure общего назначения, для начала нужно создать учетную запись хранения:

1. Откройте браузер, перейдите на [портал Azure](http://portal.azure.com) и выполните вход со своими обычными учетными данными.
1. В верхнем левом углу выберите **Все службы**.
1. Прокрутите экран вниз до раздела **Хранилище** и выберите **Учетные записи хранения**.
1. В верхнем левом углу колонки **Учетные записи хранения** выберите **Добавить**.

    ![Создание учетной записи хранения](../images/5-create-a-storage-account-1.png)

1. В текстовом поле **Имя** введите уникальное имя для учетной записи хранения.
1. Убедитесь, что в разделе **Модель развертывания** выбран параметр **Resource Manager**.
1. В раскрывающемся списке **Тип учетной записи** выберите параметр **Общего назначения версии 2**.
1. В раскрывающемся списке **Расположение** выберите ближайший к вам регион.
1. В раскрывающемся списке **Репликация** выберите параметр **Локально избыточное хранилище**.
1. В разделе **Производительность** выберите вариант **Стандарт**.
1. В разделе **Уровень доступа** выберите вариант **Холодный**.
1. В разделе **Требуется безопасное перемещение** выберите вариант **Отключено**.
1. В разделе **Подписка** выберите свою подписку.

    ![Создание учетной записи хранения](../images/5-create-a-storage-account-2.png)

1. В разделе **Группа ресурсов** выберите **Создать**, а затем в текстовом поле введите **MusicSharingResourceGroup**.
1. В разделе **Виртуальные сети** выберите вариант **Отключено**, а затем нажмите **Создать**.

    ![Создание учетной записи хранения](../images/5-create-a-storage-account-3.png)

Azure создаст новую учетную запись хранения и новую группу ресурсов.

## <a name="create-a-queue"></a>Создание очереди

После создания учетной записи хранения можно добавить в нее новую очередь. Для создания очереди используются команды PowerShell:

1. В правом верхнем углу портала нажмите на ссылку **Cloud Shell**.

    ![Запуск Cloud Shell](../images/5-create-a-storage-queue-1.png)

1. На экране **Добро пожаловать в Azure Cloud Shell** нажмите **PowerShell (Linux)**.
1. На появившемся экране **У вас не подключены хранилища** нажмите **Создать хранилище**.
1. Когда появится запрос `PS Azure` о получении учетной записи хранения, введите следующую команду, заменив `<storageaccountname>` на уникальное имя вашей учетной записи хранения, и нажмите клавишу ВВОД:

    ```powershell
    $storageaccount = Get-AzureRmStorageAccount -Name <storageaccountname> -ResourceGroup  MusicSharingResourceGroup
    ```

1. Чтобы получить контекст учетной записи хранения, введите следующую команду и нажмите клавишу ВВОД:

    ```powershell
    $context = $storageaccount.Context
    ```

1. Чтобы создать новую очередь, введите следующую команду и нажмите клавишу ВВОД:

    ```powershell
    $messageQueue = New-AzureStorageQueue -Name musicsharingmessages -Context $context
    ```

## <a name="add-a-message-to-the-queue"></a>Добавление сообщения в очередь

Теперь, когда вы создали очередь в учетной записи хранения, можно добавить в нее сообщение.

1. Чтобы создать сообщение, введите следующую команду и нажмите клавишу ВВОД:

    ```powershell
    $newSongMessage = New-Object -TypeName Microsoft.WindowsAzure.Storage.Queue.CloudQueueMessage -ArgumentList "A new song has been added."
    ```

1. Чтобы добавить новое сообщение в новую очередь, введите следующую команду и нажмите клавишу ВВОД:

    ```powershell
    $messageQueue.CloudQueue.AddMessageAsync($newSongMessage)
    ```

1. На портале Azure щелкните **Все ресурсы** в панели навигации слева.
1. В списке ресурсов выберите учетную запись хранения, которую вы создали ранее.
1. В колонке учетной записи хранения выберите **Обозреватель службы хранилища (предварительная версия)**.
1. В обозревателе службы хранилища в разделе **ОЧЕРЕДИ** выберите **musicsharingmessages**. В обозревателе службы хранилища появится добавленное вами сообщение.

## <a name="retrieve-and-remove-the-message"></a>Получение и удаление сообщения

Компонент назначения для сообщения в очереди хранилища должен извлечь сообщение в начале очереди, обработать его и удалить из очереди, чтобы его не получили другие компоненты:

1. В Azure Cloud Shell введите следующую команду, чтобы получить сообщение в начале очереди, и нажмите клавишу ВВОД:

    ```powershell
    $retrievedMessage = $messageQueue.CloudQueue.GetMessageAsync().Result
    ```

1. Чтобы отобразить сообщение, введите следующую команду и нажмите клавишу ВВОД:

    ```powershell
    $retrievedMessage.AsString
    ```

1. Чтобы отобразить все свойства сообщения, введите следующую команду и нажмите клавишу ВВОД:

    ```powershell
    $retrievedMessage
    ```

1. Чтобы удалить сообщение из очереди, введите следующую команду и нажмите клавишу ВВОД:

    ```powershell
    $messageQueue.CloudQueue.DeleteMessageAsync($retrievedMessage)
    ```

1. На портале Azure обновите экран очереди — для этого в колонке учетной записи хранения выберите **Обзор**, а затем **Обозреватель службы хранилища**.
1. В разделе **ОЧЕРЕДИ** выберите **musicsharingmessages**. Обозреватель службы хранилища показывает, что очередь пуста, поскольку единственное сообщение вы удалили.

## <a name="cleanup"></a>Очистка

Чтобы удалить все ресурсы, созданные во время этого упражнения, введите в Azure Cloud Shell следующую команду: 
```powershell
Remove-AzureRmResourceGroup -Name "MusicSharingResourceGroup" -Force
```


## <a name="summary"></a>Сводка

Вы создали учетную запись хранения в своей подписке Azure и добавили в нее новую очередь. Вы также использовали PowerShell для имитации действий компонентов распределенного приложения, когда добавили сообщение в очередь, а затем извлекли его и удалили.

Очереди учетной записи хранения Azure — отличный вариант для передачи сообщений между компонентами распределенного приложения. Не выбирайте очереди хранилища, если собираетесь публиковать события.