На этом этапе мобильное приложение готово и отправляет данные о местоположении и список номеров телефонов пользователя функции Azure, которая может десериализовать эти данные. В этом модуле вы привяжете функцию Azure к Twilio для отправки SMS-сообщений.

Функции Azure можно подключить к другим службам — службам в Azure или сторонним службам. Эти подключения, называемые привязками, существуют в двух формах — входные и выходные привязки. Входные привязки предоставляют данные в функцию, а выходные получают данные из функции и отправляют их другой службе. Дополнительные сведения читайте в [документации о привязках функций Azure](https://docs.microsoft.com/azure/azure-functions/functions-triggers-bindings).

Привязки для функций Azure, созданные в Visual Studio, определяются с помощью параметров функции, дополненных атрибутами.

## <a name="bind-the-azure-function-to-twilio"></a>Привязка функции Azure к Twilio

Для отправки SMS сообщений через Twilio требуется выходная привязка, которая настраивается с помощью идентификатора подписки вашей учетной записи (идентификатор безопасности) и маркера проверки подлинности.

1. Если локальная среда выполнения функций Azure работает, остановите ее.

2. Добавьте пакет "Microsoft.Azure.WebJobs.Extensions.Twilio" NuGet в проект `ImHere.Functions`. Этот пакет NuGet содержит соответствующие классы для привязки.

3. Добавьте новый параметр в статический метод `Run` в статическом классе `SendLocation` с именем `messages`. Этот параметр имеет тип `ICollector<SMSMessage>`. Вам потребуется добавить директиву using для пространства имен `Twilio`.

    ```cs
    [FunctionName("SendLocation")]
    public static async Task<HttpResponseMessage> Run([HttpTrigger(AuthorizationLevel.Anonymous,
                                                                   "get", "post",
                                                                   Route = null)]HttpRequestMessage req,
                                                      ICollector<SMSMessage> messages,
                                                      TraceWriter log)
    ```

4. Дополните новый параметр `messages` атрибутом `TwilioSms`. Этот атрибут имеет три параметра, которые необходимо задать.

    | Параметр      |  Значение   | ОПИСАНИЕ                                        |
    | --- | --- | ---|
    | **AccountSidSetting** | "TwilioAccountSid" | Идентификатор безопасности вашей учетной записи в Twilio. Вместо того, чтобы задать идентификатор безопасности напрямую, этот параметр представляет собой имя значения в параметрах приложения-функции, которое будет использоваться для получения идентификатора безопасности. |
    | **AuthTokenSetting** | "TwilioAuthToken" | Маркер проверки подлинности вашей учетной записи в Twilio. Вместо того, чтобы задать маркер проверки подлинности напрямую, этот параметр представляет собой имя значения в параметрах приложения-функции, которое будет использоваться для получения маркера проверки подлинности. |
    | **from** | Ваш номер телефона Twilio | Номер телефона Twilio, на который будут отправляться SMS-сообщения, должен быть указан в международном формате (+\<код страны\>\<номер телефона\>, например +1555123456). |

    При создании учетной записи Twilio вам назначается номер телефона, с которого можно отправлять сообщения. Этот номер телефона в указан на панели **номеров телефонов** в Twilio. На сайте Twilio нажмите на многоточие в нижней части левого меню. Выберите *СУПЕРСЕТЬ -> Номера телефонов*. Вы можете закрепить эту панель мониторинга на левом меню, нажав на значок булавки. Ваш номер Twilio будет находиться в разделе *Управление номерами -> Активные номера*. Номер должен быть указан без пробелов.

    ![Поиск номера Twilio](../media-drafts/7-twilio-find-number.png)

    ```cs
    [TwilioSms(AccountSidSetting = "TwilioAccountSid",
               AuthTokenSetting = "TwilioAuthToken",
               From = "+1xxxxxxxxx")]ICollector<SMSMessage> messages,
    ```

5. Параметры приложения-функции можно настроить локально внутри файла `local.settings.json`. Добавьте идентификатор безопасности учетной записи Twilio и маркер проверки подлинности в этот файл JSON, используя имена параметров, которые были переданы атрибуту `TwilioSMS`.

    ```json
    {
        "IsEncrypted": false,
        "Values": {
            "AzureWebJobsStorage": "UseDevelopmentStorage=true",
            "AzureWebJobsDashboard": "UseDevelopmentStorage=true",
            "TwilioAccountSid": "<Your SID>",
            "TwilioAuthToken": "<Your Auth Token>"
        }
    }
    ```

    Замените значения \<Ваш ИД безопасности\> и \<Ваш маркер проверки подлинности\> значениями с панели мониторинга Twilio.

    > Эти локальные параметры будут использоваться только для локального запуска. В рабочем приложении в качестве этих значений будут использоваться ваши данные для входа в локальную учетную запись разработки или тестирования. Когда функция Azure будет развернута в Azure, вы сможете настроить рабочие значения.
    > Если отправить код в систему управления версиями, эти локальные значения параметров приложения будут загружены тоже, так что не загружайте фактические значения в этих файлах, если ваш код имеет открытый источник или является общедоступным.

## <a name="create-the-sms-messages"></a>Создание SMS-сообщений

Параметр `ICollector<SMSMessage>` — это коллекция экземпляров `SMSMessage`. Он используется для сбора SMS-сообщений, которые вы хотите отправить. После того как функция будет выполнена, любые экземпляры `SMSMessage`, добавленные в эту коллекцию, передаются в Twilio и рассылаются соответствующим получателям.

1. В функции `SendLocation` добавьте код для циклического прохождения через телефонные номера в `PostData` и создайте SMS-сообщение для каждого из них.

    ```cs
    foreach (string toNo in data.ToNumbers)
    {
        SMSMessage message = new SMSMessage
        {
            Body = $"I'm here! {url}",
            To = toNo
        };
    }
    ```

    Сообщению нужен номер телефона для отправки и текст, который содержит URL-адрес Google Maps, созданный на основе местоположения пользователя.

2. Записывайте каждое сообщение и добавляйте его в коллекцию `messages`.

    ```cs
    foreach (string toNo in data.ToNumbers)
    {
        ...
        log.Info($"Creating SMS message to {message.To}, message is '{message.Body}'.");
        messages.Add(message);
    }
    ```

Полный метод `SendLocation` приведен ниже.

```cs
[FunctionName("SendLocation")]
public static async Task<HttpResponseMessage> Run([HttpTrigger(AuthorizationLevel.Anonymous,
                                                                "get", "post",
                                                                Route = null)]HttpRequestMessage req,
                                                    [TwilioSms(AccountSidSetting = "TwilioAccountSid",
                                                                AuthTokenSetting = "TwilioAuthToken",
                                                                From = "<your Twilio phone number>")]ICollector<SMSMessage> messages,
                                                    TraceWriter log)
{
    log.Info("C# HTTP trigger function processed a request.");
    PostData data = await req.Content.ReadAsAsync<PostData>();
    string url = $"https://www.google.com/maps/search/?api=1&query={data.Latitude},{data.Longitude}";
    log.Info($"URL created - {url}");
    foreach (string toNo in data.ToNumbers)
    {
        SMSMessage message = new SMSMessage
        {
            Body = $"I'm here! {url}",
            To = toNo
        };
        log.Info($"Creating SMS message to {message.To}, message is '{message.Body}'.");
        messages.Add(message);
    }
    return req.CreateResponse(HttpStatusCode.OK);
}
```

## <a name="test-it-out"></a>Тестирование

1. Настройте приложение `ImHere.Functions` как начальный проект и запустите его без отладки.

2. Настройте приложение `ImHere.UWP` как начальный проект и запустите его.

3. Введите номер телефона в международном формате (+\<код страны\>\<номер телефона\>) в приложении Xamarin.Forms. Пробные учетные записи Twilio могут отправлять сообщения только на подтвержденные номера телефонов, поэтому сейчас вы сможете отправить сообщение только себе, если только не перейдете на платную учетную запись или не подтвердите другие номера.

4. Нажмите кнопку **Send Location** (Отправить данные о местоположении). Если SMS-сообщение отправлено успешно, вы увидите сообщение в приложении Xamarin.Forms о том, что данные о местоположении успешно отправлены.

    ![Приложение Xamarin.Forms, показывающее отправку данных о местоположении](../media-drafts/7-ui-location-sent.png)

5. В журналах консоли для функции Azure вы увидите, что сообщение создано и отправлено. Если возникли ошибки (например, номер указан в неверном формате), они будут записаны здесь.

    ![Консоль функции Azure, отображающая, что сообщение было отправлено](../media-drafts/7-function-message-sent.png)

6. Проверьте сообщение на телефоне. Перейдите по ссылке в сообщении, чтобы увидеть ваше местоположение.

    ![SMS-сообщение, полученное на мобильный телефон](../media-drafts/7-message-received.png)

## <a name="summary"></a>Сводка

В этом модуле вы узнали, как создать привязку Twilio для функции Azure и отправить SMS-сообщение с местоположением пользователя локально запущенной функции. В следующем модуле вы опубликуете функцию в Azure.