Для выполнения сложных или повторяющихся задач часто требуется немало административного времени. Организации предпочитают автоматизировать эти задачи, чтобы сократить затраты и избежать возникновения ошибок.

Этот момент имеет важное значение в примере компании CRM. В нем вы тестируете программное обеспечение на нескольких виртуальных машинах Linux, которые необходимо постоянно удалять и создавать повторно. Вы хотите использовать сценарий PowerShell, позволяющий автоматизировать создание виртуальных машин.

Помимо базовой операции по созданию виртуальной машины, у вас есть несколько дополнительных требований к сценарию. 
- Поскольку вы будете создавать несколько виртуальных машин, операцию создания необходимо поместить в цикл.
- Вам необходимо создать виртуальные машины в трех разных группах ресурсов, поэтому имя группы ресурсов должно передаваться в сценарий в виде параметра.

В этом разделе вы узнаете, как создавать и выполнять сценарий Azure PowerShell, который отвечает этим требованиям.

## <a name="what-is-a-powershell-script"></a>Что такое сценарий PowerShell?
Сценарий PowerShell — это текстовый файл, содержащий команды и управляющие конструкции. Команды являются вызовами командлетов. Управляющие конструкции представляют собой компоненты программирования, такие как циклы, переменные, параметры, комментарии и т. д., предоставляемые PowerShell.

Файлы сценариев PowerShell имеют расширение **PST1**. Эти файлы можно создавать и сохранять в любом текстовом редакторе. 

> [!TIP]
> Если вы пишете сценарии PowerShell в Windows, можно использовать интегрированную среду сценариев (ISE) Windows PowerShell. Этот редактор предоставляет такие функции, как раскраска синтаксических конструкций и список доступных командлетов.
>
>![Среда ISE Windows PowerShell](../media-drafts/7-windows-powershell-ise-screenshot.png)

После написания сценария выполните его из командной строки PowerShell, передав имя файла, в начале которого стоит точка и обратная косая черта:

```powershell
.\myScript.ps1
```

## <a name="powershell-techniques"></a>Методы PowerShell
PowerShell поддерживает множество функций, которые встречаются в стандартных языках программирования. Вы можете определять переменные, использовать ветви и циклы, записывать параметры командной строки, создавать функции, добавлять комментарии и т. д. Для сценария нам потребуются три компонента: переменные, циклы и параметры.

### <a name="variables"></a>Переменные
PowerShell поддерживает переменные. Используйте **$** для объявления переменной и **=** для присвоения значения. Например:

```powershell
$loc = "East US"
$iterations = 3
```

Переменные могут содержать объекты. Например, следующее определение задает переменную **adminCredential** для объекта, возвращаемого командлетом **Get-Credential**.

```powershell
$adminCredential = Get-Credential
```

Чтобы получить значение, сохраненное в переменной, используйте префикс **$** и его имя, как показано ниже. 

```powershell
$loc = "East US"
New-AzureRmResourceGroup -Name "MyResourceGroup" -Location $loc
```

### <a name="loops"></a>Циклы
PowerShell имеет несколько циклов: **For**, **Do...While**, **For...Each** и т. д. Цикл **For** подходит нам лучше всего, так как мы будем выполнять командлет фиксированное число раз.

Основной синтаксис показан ниже. Пример выполняется два раза и каждый раз выводит значение **i**. Операторы сравнения записываются следующим образом: **- lt** — меньше чем, **-le** — меньше или равно, **eq** — равно, **ne** — не равно.

```powershell
For ($i = 1; $i -lt 3; $i++)
{
    $i
}
```

### <a name="parameters"></a>Параметры
При выполнении сценария можно передать аргументы в командной строке. Чтобы упростить получение значений в сценарии, укажите имена для каждого параметра. Например: 

```powershell
.\setupEnvironment.ps1 -size 5 -location "East US"
```

Внутри скрипта значения записываются в переменные. В этом случае параметры сопоставляются по имени:

```powershell
param([string]$location, [int]$size)
```

Имена из командной строки можно опустить. Например:

```powershell
.\setupEnvironment.ps1 5 "East US"
```

Если в сценарии используются неименованные параметры, при сопоставлении во внимание принимается позиция:

```powershell
param([int]$size, [string]$location)
```

## <a name="how-to-create-a-linux-virtual-machine"></a>Создание виртуальной машины Linux
Для создания виртуальной машины Azure PowerShell предоставляет командлет **New-AzureRmVm**. У командлета много параметров, позволяющих обрабатывать множество параметров конфигурации виртуальной машины. Большая часть параметров имеет разумные значения по умолчанию, поэтому нам нужно указать только пять.
- **ResourceGroupName**: группа ресурсов, в которой будет размещена новая виртуальная машина.
- **Имя**: имя виртуальной машины.
- **Расположение**: географическое расположение, где будет подготовлена виртуальная машина.
- **Учетные данные**: объект, содержащий имя пользователя и пароль для учетной записи администратора виртуальной машины. Для запроса имени пользователя и пароля мы будем использовать командлет **Get-Credential**. Командлет **Get-Credential** упаковывает имя пользователя и пароль в объект учетных данных, который он возвращает в результате выполнения.
- **Образ**: удостоверение операционной системы для виртуальной машины. Мы будем использовать "UbuntuLTS".

Синтаксис командлета приведен ниже.

```powershell
   New-AzureRmVm 
       -ResourceGroupName <resource group name> 
       -Name <machine name> 
       -Credential <credentials object> 
       -Location <location> 
       -Image <image name>
```

## <a name="summary"></a>Сводка
Благодаря сочетанию PowerShell и Azure PowerShell вы получаете все средства, необходимые для автоматизации задач в Azure. В примере CRM мы сможем создать несколько виртуальных машин Linux, используя параметр, чтобы сохранить универсальность сценария, и цикл, чтобы избежать повторяющегося кода. Это означает, что прежняя сложная операция теперь может выполняться за один шаг.