Получив ссылку на BLOB-объект, можно отправлять и скачивать данные. Объекты `ICloudBlob` имеют методы `Upload` и `Download`, которые поддерживают массивы байтов, потоки и файлы в качестве источников и целевых объектов. Определенные типы имеют дополнительные методы, повышающие удобство работы. Например, `CloudBlockBlob` поддерживает отправку и скачивание строк с помощью методов `UploadTextAsync` и `DownloadTextAsync`.

## <a name="creating-new-blobs"></a>Создание BLOB-объектов

Чтобы создать BLOB-объект, нужно вызвать один из методов `Upload` для несуществующего BLOB-объекта. При этом выполняются два действия: создается BLOB-объект и отправляются данные. 

## <a name="moving-data-to-and-from-blobs"></a>Перемещение данных в BLOB-объекты и из них

Перемещение данных в BLOB-объект или из него является сетевой операцией и требует времени. В SDK службы хранилища Azure для .NET Core все методы, требующие сетевой активности, возвращают объекты `Task`, поэтому методы контроллера должны быть `async`, а для вызовов методов необходимо выполнять `await`, а не `Wait`.

При работе с большими объектами данных, как правило, рекомендуется использовать потоки вместо структур в памяти, таких как массивы байтов или строки. Это позволяет избежать буферизации всего содержимого в памяти перед его отправкой целевому объекту. ASP.NET Core поддерживает считывание потоков из запросов и ответов и запись потоков в них.

## <a name="concurrent-access"></a>Одновременный доступ

В процессе использования BLOB-объектов приложением другие процессы могут добавлять, изменять или удалять их. При написании кода будьте внимательны и учитывайте проблемы, вызываемые параллелизмом, например возможность того, что BLOB-объект, из которого вы пытаетесь скачать данные, был удален или что содержимое BLOB-объектов может непредвиденно меняться. Сведения об использовании AccessConditions и аренды BLOB-объектов для управления одновременным доступом к BLOB-объектам см. в разделе "Дополнительные ресурсы" в конце этого модуля.

## <a name="exercise"></a>Упражнение

Давайте завершим приложение, добавив код для отправки и скачивания данных, а затем развернем его в Службе приложений Azure для тестирования.

### <a name="upload"></a>Передать

Для отправки BLOB-объекта мы реализуем метод `BlobStorage.Save` с помощью `GetBlockBlobReference` для получения объекта `CloudBlockBlob` из контейнера. `FilesController.Upload` передает файловый поток в метод `Save`, поэтому мы можем использовать `UploadFromStreamAsync` для выполнения отправки с максимальной эффективностью.

Откройте файл `BlobStorage.cs` в редакторе и заполните реализацию метода `Save` следующим кодом:

```csharp
public Task Save(Stream fileStream, string name)
{
    CloudStorageAccount storageAccount = CloudStorageAccount.Parse(storageConfig.ConnectionString);
    CloudBlobClient blobClient = storageAccount.CreateCloudBlobClient();
    CloudBlobContainer container = blobClient.GetContainerReference(storageConfig.FileContainerName);
    CloudBlockBlob blockBlob = container.GetBlockBlobReference(name);
    return blockBlob.UploadFromStreamAsync(fileStream);
}
```

> [!NOTE]
> Приведенный здесь код отправки на основе потока работает эффективнее, чем считывание файла в массив байтов перед отправкой в хранилище BLOB-объектов Azure. Однако использование `IFormFile` для получения файла от клиента не является потоковой реализацией в полном смысле этого слова и подходит для отправки только небольших файлов. Сведения об отправке файлов в полностью потоковом режиме см. в разделе "Дополнительные ресурсы" в конце этого модуля.

### <a name="download"></a>Загрузка

Метод `BlobStorage.Load` возвращает объект `Stream`. Это означает, что в коде не нужно физически перемещать байты из хранилища BLOB-объектов. Необходимо всего лишь вернуть ссылку на поток BLOB-объекта. Это можно сделать с помощью `OpenReadAsync`. ASP.NET Core будет обрабатывать чтение и закрытие потока при создании ответа клиента.

Заполните метод `Load` следующим кодом:

```csharp
public Task<Stream> Load(string name)
{
    CloudStorageAccount storageAccount = CloudStorageAccount.Parse(storageConfig.ConnectionString);
    CloudBlobClient blobClient = storageAccount.CreateCloudBlobClient();
    CloudBlobContainer container = blobClient.GetContainerReference(storageConfig.FileContainerName);
    return container.GetBlobReference(name).OpenReadAsync();
}
```

### <a name="deploy-and-run-in-azure"></a>Развертывание и запуск в Azure

Наше приложение готово. Давайте развернем его и посмотрим, как оно работает. В терминале Azure Cloud Shell выполните приведенный ниже код, чтобы выполнить сборку кода и развернуть его в новом экземпляре службы приложений. Кроме того, мы добавим в конфигурацию строку подключения к учетной записи хранения.

```console

```

...

Отправьте и скачайте файлы, чтобы протестировать приложение, а затем выполните в оболочке следующую команду, чтобы просмотреть отправленные BLOB-объекты:

```console

```

**Изображение списка задач с портала**